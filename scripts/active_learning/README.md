# Use an active learning strategy to improve the ground truths

This README explains the steps that were performed to improve the quality of the ground truths segmentations used to train TotalSpineSeg.

## Original ground truths limitation
> For more information about the training, see https://www.researchgate.net/publication/389881289_TotalSpineSeg_Robust_Spine_Segmentation_with_Landmark-Based_Labeling_in_MRI 

Due to the time-consuming nature of manually segmenting the anatomical structures identified by TotalSpineSeg namely the spinal cord, spinal canal, vertebrae, and intervertebral discs, the [PAM50 atlas](https://pubmed.ncbi.nlm.nih.gov/29061527/) was registered to the native space of each scan that included the cervical and/or thoracic regions to serve as ground truth segmentation. However, because of inter-subject anatomical variability, the atlas did not perfectly align with every subject anatomy. These subtle misalignments introduced inconsistencies that propagated into the modelâ€™s predictions, often resulting in over- or under-segmentation of certain structures. This issue affects models trained up to and including release `r20250224`.

## Refinement of the existing ground truth (T2w)

These ground truth refinements will be done using existing contrasts specific deep learning models and manual corrections of the predictions.

### Canal segmentations

To improve the canal segmentations, the model [sc_canal_t2](https://spinalcordtoolbox.com/stable/user_section/command-line/deepseg/sc_canal_t2.html) available inside the spinalcord toolbox was used. The following steps present the process step by step:
> Note: This model is limited to T2w images

1. Install the [spinalcordtoolbox](https://github.com/spinalcordtoolbox/spinalcordtoolbox?tab=readme-ov-file#installation).
2. Install the canal segmentation model
```bash
sct_deepseg sc_canal_t2 -install
```
3. Run the model on niftii images
```bash
sct_deepseg sc_canal_t2 -i img.nii.gz -o canal.nii.gz
```

### Spine segmentations

To improve the vertebrae and discs segmentations, the model [spineps](https://github.com/Hendrik-code/spineps) was used. The following steps present the process step by step:
> Note: The release [1.3.0](https://github.com/Hendrik-code/spineps/releases/tag/v1.3.0) was used here.

1. Install [spineps](https://github.com/Hendrik-code/spineps?tab=readme-ov-file#installation-ubuntu)
2. Run the model on niftii images
```bash
spineps sample -ignore_bids_filter -ignore_inference_compatibility -i img.nii.gz -model_semantic t2w -model_instance instance -der_name spineps_folder
```

Because the version [1.3.0](https://github.com/Hendrik-code/spineps/releases/tag/v1.3.0) of SPINEPS only provides instance segmentations (vertebrae/discs are unlabeled). TotalSpineSeg `r20250224` was also used on the same images to have access to the labels,
and the canal segmentations were also used to remove segmented voxels of vertebrae and discs from the canal region. These last steps were performed using this last script.

```bash
python spineps_refine -spineps spineps_folder -totalspineseg step2_output -canal canal_folder -ofolder labels_refined
```
- `spineps_folder` is the output folder generated by SPINEPS
- `step2_output` is the output folder generated by totalspineseg
- `canal_folder` contains all the predictions generated by `sct_deepseg sc_canal_t2`
- `labels_refined` is the BIDS like output folder







